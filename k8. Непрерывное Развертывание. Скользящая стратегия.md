
> [[k8]] [[IT]] [[Liveness –∏ Readiness Probes]]

–£ Kubernetes –µ—Å—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å—Ç—Ä–∞—Ç–µ–≥–∏–π **–±–µ—Å—à–æ–≤–Ω–æ–≥–æ (zero-downtime)** –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è.  
**`RollingUpdate`** ‚Äî —Å—Ç—Ä–∞—Ç–µ–≥–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –¥–ª—è `Deployment` (–µ—Å–ª–∏ `strategy` –Ω–µ —É–∫–∞–∑–∞–Ω —è–≤–Ω–æ).  

–ü—Ä–∏–Ω—Ü–∏–ø —Ä–∞–±–æ—Ç—ã:  
‚úÖ –°–æ–∑–¥–∞—ë—Ç—Å—è **–Ω–æ–≤—ã–π –ø–æ–¥** —Å –æ–±–Ω–æ–≤–ª—ë–Ω–Ω–æ–π –≤–µ—Ä—Å–∏–µ–π  
‚úÖ Kubernetes **–∂–¥—ë—Ç**, –ø–æ–∫–∞ –æ–Ω —Å—Ç–∞–Ω–µ—Ç `Ready` (—á–µ—Ä–µ–∑ `readinessProbe`)  
‚úÖ –¢–æ–ª—å–∫–æ —Ç–æ–≥–¥–∞ **—É–¥–∞–ª—è–µ—Ç—Å—è –æ–¥–∏–Ω —Å—Ç–∞—Ä—ã–π –ø–æ–¥**  
üîÅ –ü–æ–≤—Ç–æ—Ä—è–µ—Ç—Å—è, –ø–æ–∫–∞ –≤—Å–µ –ø–æ–¥—ã –Ω–µ –æ–±–Ω–æ–≤—è—Ç—Å—è.

> üîó **–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å**:  
> –ë–µ–∑ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π `readinessProbe` (—Å–º. [[Liveness –∏ Readiness Probes]]) RollingUpdate **–Ω–µ –æ–±–µ—Å–ø–µ—á–∏—Ç** –±–µ—Å—à–æ–≤–Ω–æ—Å—Ç—å ‚Äî —Ç—Ä–∞—Ñ–∏–∫ –º–æ–∂–µ—Ç –ø–æ–π—Ç–∏ –≤ –Ω–µ–≥–æ—Ç–æ–≤—ã–π –ø–æ–¥.

---

## –ö–∞–∫ —ç—Ç–æ –≤—ã–≥–ª—è–¥–∏—Ç –≤ –∫–æ–Ω—Ñ–∏–≥–µ

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: k8-test
spec:
  replicas: 3
  selector:
    matchLabels:
      pod: k8-test-pod
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxUnavailable: 1   # ‚Üê —Å–∫–æ–ª—å–∫–æ –ø–æ–¥–æ–≤ –ú–û–ñ–ï–¢ –±—ã—Ç—å –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ
      maxSurge: 2         # ‚Üê —Å–∫–æ–ª—å–∫–æ –í–†–ï–ú–ï–ù–ù–´–• –ø–æ–¥–æ–≤ –º–æ–∂–Ω–æ —Å–æ–∑–¥–∞—Ç—å —Å–≤–µ—Ä—Ö replicas
  template:
    metadata:
      labels:
        pod: k8-test-pod
    spec:
      containers:
        - name: k8-test-container
          image: docker.io/macalistervadim/k8-test:latest
          # ‚Üê readinessProbe –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–ê –∑–¥–µ—Å—å!
          readinessProbe:
            httpGet:
              path: /health
              port: 8000
            initialDelaySeconds: 15
            periodSeconds: 10
```

![[Kubernetes –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤.jpeg]]

## `maxUnavailable` ‚Äî —Å–∫–æ–ª—å–∫–æ –º–æ–∂–Ω–æ "—É—Ä–æ–Ω–∏—Ç—å"

–û–ø—Ä–µ–¥–µ–ª—è–µ—Ç **–º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–¥–æ–≤, –∫–æ—Ç–æ—Ä–æ–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ** –≤–æ –≤—Ä–µ–º—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è.

- –ó–Ω–∞—á–µ–Ω–∏–µ: **—Ü–µ–ª–æ–µ —á–∏—Å–ª–æ** (`1`, `2`) –∏–ª–∏ **–ø—Ä–æ—Ü–µ–Ω—Ç** (`25%`, `50%`)
- –ü—Ä–∏ `replicas: 4`, `maxUnavailable: 25%` ‚Üí –º–∞–∫—Å. 1 –ø–æ–¥ –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω

> [!warning] –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è –¥–ª—è production  
> **`maxUnavailable: 0`** ‚Äî _–Ω–∞–∏–ª—É—á—à–∏–π –≤—ã–±–æ—Ä_, –µ—Å–ª–∏:
> 
> - –£ –≤–∞—Å –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è `readinessProbe`,
> - –í –∫–ª–∞—Å—Ç–µ—Ä–µ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Ä–µ—Å—É—Ä—Å–æ–≤ (CPU/RAM) –¥–ª—è –≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ —Ä–æ—Å—Ç–∞ –ø–æ–¥–æ–≤.
> 
> –≠—Ç–æ –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç, —á—Ç–æ **—ë–º–∫–æ—Å—Ç—å —Å–µ—Ä–≤–∏—Å–∞ –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ –ø–∞–¥–∞–µ—Ç** ‚Äî –¥–∞–∂–µ –Ω–∞ 1 –∑–∞–ø—Ä–æ—Å.  
> –ù–µ–¥–æ—Å—Ç–∞—Ç–æ–∫: –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –º–µ–¥–ª–µ–Ω–Ω–µ–µ (–Ω–æ –±–µ–∑–æ–ø–∞—Å–Ω–µ–µ!).

> ‚ö†Ô∏è `maxUnavailable: 1` –ø—Ä–∏ `replicas: 3` = **33% –ø–æ—Ç–µ—Ä—è —ë–º–∫–æ—Å—Ç–∏** ‚Äî –º–æ–∂–µ—Ç –ø—Ä–∏–≤–µ—Å—Ç–∏ –∫ 5xx –ø—Ä–∏ –ø–∏–∫–æ–≤–æ–π –Ω–∞–≥—Ä—É–∑–∫–µ.

## `maxSurge` ‚Äî —Å–∫–æ–ª—å–∫–æ "–ª–∏—à–Ω–∏—Ö" –ø–æ–¥–æ–≤ –º–æ–∂–Ω–æ —Å–æ–∑–¥–∞—Ç—å

–û–ø—Ä–µ–¥–µ–ª—è–µ—Ç **–º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –ø—Ä–µ–≤—ã—à–µ–Ω–∏–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –ø–æ–¥–æ–≤ –Ω–∞–¥ `replicas`** –≤–æ –≤—Ä–µ–º—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è.

- –ü—Ä–∏–º–µ—Ä: `replicas: 5`, `maxSurge: 2` ‚Üí –º–∞–∫—Å–∏–º—É–º **7** –ø–æ–¥–æ–≤ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ (5 —Å—Ç–∞—Ä—ã—Ö + 2 –Ω–æ–≤—ã—Ö, –∏–ª–∏ 4 —Å—Ç–∞—Ä—ã—Ö + 3 –Ω–æ–≤—ã—Ö –∏ —Ç.–¥.)
- –ó–Ω–∞—á–µ–Ω–∏–µ: —á–∏—Å–ª–æ –∏–ª–∏ –ø—Ä–æ—Ü–µ–Ω—Ç (`25%`, `100%`)

> [!tip] –≠–∫–æ–Ω–æ–º–∏—è —Ä–µ—Å—É—Ä—Å–æ–≤  
> –ü—Ä–∏ –∂—ë—Å—Ç–∫–æ–º –ª–∏–º–∏—Ç–µ CPU/RAM:
> 
> - `maxSurge: 0`, `maxUnavailable: 1` ‚Üí –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ ¬´–Ω–∞ –º–µ—Å—Ç–µ¬ª (–º–µ–¥–ª–µ–Ω–Ω–æ, —Å –ø—Ä–æ—Å–∞–¥–∫–æ–π —ë–º–∫–æ—Å—Ç–∏)
> - –ù–æ **–Ω–∏–∫–æ–≥–¥–∞ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ `maxSurge: 0` + `maxUnavailable: 0`** ‚Äî —Å–º. –Ω–∏–∂–µ.

> [!danger] –ö—Ä–∏—Ç–∏—á–µ—Å–∫–æ–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ  
> `maxUnavailable` –∏ `maxSurge` **–Ω–µ –º–æ–≥—É—Ç –±—ã—Ç—å –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ —Ä–∞–≤–Ω—ã 0**.  
> –ò–Ω–∞—á–µ Deployment **–∑–∞–±–ª–æ–∫–∏—Ä—É–µ—Ç—Å—è** –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ `Progressing`, –ø–æ—Ç–æ–º—É —á—Ç–æ:
> 
> - –£–¥–∞–ª–∏—Ç—å —Å—Ç–∞—Ä—ã–µ –ø–æ–¥—ã –Ω–µ–ª—å–∑—è (`maxUnavailable: 0`),
> - –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–µ –Ω–µ–ª—å–∑—è (`maxSurge: 0`).
> 
> ‚úÖ –ë–µ–∑–æ–ø–∞—Å–Ω—ã–µ ¬´–Ω—É–ª–µ–≤—ã–µ¬ª –∫–æ–º–±–∏–Ω–∞—Ü–∏–∏:
> 
> - `maxUnavailable: 0`, `maxSurge: 1` ‚Üí 100% uptime, +1 –≤—Ä–µ–º–µ–Ω–Ω—ã–π –ø–æ–¥
> - `maxUnavailable: 1`, `maxSurge: 0` ‚Üí —ç–∫–æ–Ω–æ–º–∏—è —Ä–µ—Å—É—Ä—Å–æ–≤, ‚àí1 –ø–æ–¥ –≤ —Ä–∞–±–æ—Ç–µ