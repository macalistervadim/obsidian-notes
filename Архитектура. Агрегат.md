**Агрегат** — это группа связанных доменных объектов (моделей), объединённых вокруг одного главного объекта — корня агрегата.

Он задаёт **рамки согласованности**: все изменения внутри агрегата происходят как единое целое, гарантируя целостность и непротиворечивость данных.

Таким образом агрегат рассматривается как атомарная единица изменения в бизнес-логике.

**Главные моменты, которые стоит подчеркнуть:**

- В агрегате всегда есть **корень агрегата** — главный объект, через который всё идёт.
- Это группа моделей с общей бизнес-логикой.
- Внутри агрегата соблюдаются **инварианты** (правила), которые нельзя нарушать.
- Внешний код взаимодействует только с корнем агрегата.
- Изменения агрегата — атомарны (в рамках одной транзакции или операции).

>[!summary] Примеры кода

```python
class OrderLine:
    def __init__(self, sku: str, qty: int):
        self.sku = sku
        self.qty = qty

class Order:
    def __init__(self, order_id: str):
        self.order_id = order_id
        self.lines: list[OrderLine] = []

    def add_line(self, sku: str, qty: int):
        if qty <= 0:
            raise ValueError("Quantity must be positive")
        self.lines.append(OrderLine(sku, qty))

    def total_quantity(self):
        return sum(line.qty for line in self.lines)

```

- **Order** — корень агрегата.
- Все изменения позиций заказа (`OrderLine`) происходят через `Order`
- Гарантируется, что нельзя добавить позицию с нулевым количеством (инвариант).
- Внешний код не может напрямую менять `OrderLine` — только через `Order`.

[[Родительские классы/IT/Архитектура/Архитектура|Архитектура]] [[IT]]